# KBase RAG - æç®€RAGçŸ¥è¯†åº“ç³»ç»Ÿ

åŸºäº Elasticsearch 9.x çš„è½»é‡çº§ RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ç³»ç»Ÿï¼Œæ”¯æŒå¤šæ ¼å¼æ–‡æ¡£ä¸Šä¼ ã€è…¾è®¯äº‘COSé›†æˆã€æ–‡æœ¬åˆ†ç‰‡ã€å‘é‡åŒ–å’Œæ··åˆè¯­ä¹‰æœç´¢ã€‚

## âœ¨ ç‰¹æ€§

- ğŸ“„ **å¤šæ ¼å¼æ–‡æ¡£è§£æ** - æ”¯æŒPDFã€Markdownã€TXTæ–‡ä»¶ä¸Šä¼ å’Œæ–‡æœ¬æå–
- ğŸ” **æ··åˆæœç´¢** - ç»“åˆæ–‡æœ¬åŒ¹é…å’Œå‘é‡è¯­ä¹‰æœç´¢ï¼Œæ”¯æŒæƒé‡é…ç½®
- â˜ï¸ **äº‘å­˜å‚¨é›†æˆ** - æ”¯æŒè…¾è®¯äº‘COSç›´æ¥URLä¸Šä¼ 
- âš¡ **é«˜æ€§èƒ½** - åŸºäº Elasticsearch 9.xï¼Œæ”¯æŒå¤§è§„æ¨¡æ–‡æ¡£æ£€ç´¢
- ğŸ **ç°ä»£Python** - ä½¿ç”¨ FastAPIã€Pydanticã€ç±»å‹æ³¨è§£ç­‰ç°ä»£å·¥å…·
- ğŸ”§ **ä¼ä¸šçº§è´¨é‡** - å®Œæ•´çš„ç±»å‹æ£€æŸ¥ã€ä»£ç è§„èŒƒã€æµ‹è¯•è¦†ç›–
- ğŸ›¡ï¸ **æƒé™å¤„ç†** - ä¼˜é›…å¤„ç†COSæƒé™é™åˆ¶ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œ

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **Python**: 3.12
- **uv**: ç°ä»£PythonåŒ…ç®¡ç†å™¨ï¼ˆå¼ºçƒˆæ¨èï¼‰
- **Elasticsearch**: 9.xï¼ˆç”¨äºæ–‡æ¡£å­˜å‚¨å’Œæœç´¢ï¼‰

### 1. å®‰è£… uv

**macOS/Linux:**
```bash
curl -LsSf https://astral.sh/uv/install.sh | sh
source ~/.bashrc  # æˆ–é‡æ–°æ‰“å¼€ç»ˆç«¯
```

**Windows:**
```powershell
powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"
```

**éªŒè¯å®‰è£…:**
```bash
uv --version
```

### 2. é¡¹ç›®è®¾ç½®

```bash
# å…‹éš†é¡¹ç›®
git clone <your-repo>
cd kbase

# ä¸€é”®è®¾ç½®å¼€å‘ç¯å¢ƒ
make setup
```

`make setup` ä¼šè‡ªåŠ¨ï¼š
- âœ… åˆ›å»º Python 3.12 è™šæ‹Ÿç¯å¢ƒ
- âœ… å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘å·¥å…·ï¼‰
- âœ… é…ç½® Git é¢„æäº¤é’©å­

### 3. å¯åŠ¨ Elasticsearch

**ä½¿ç”¨ Dockerï¼ˆæ¨èï¼‰:**
```bash
make e2e_down && make e2e_up
```

**éªŒè¯ ES è¿è¡Œ:**
```bash
curl http://localhost:9200
```

### 4. å¯åŠ¨åº”ç”¨

```bash
# æ¿€æ´»ç¯å¢ƒï¼ˆå¦‚æœæœªæ¿€æ´»ï¼‰
source .venv/bin/activate

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
make run
```

åº”ç”¨å°†åœ¨ http://localhost:8080 å¯åŠ¨

## ğŸ“‹ å¼€å‘å‘½ä»¤

| å‘½ä»¤           | æè¿°              |
|--------------|-----------------|
| `make setup` | ğŸš€ ä¸€é”®è®¾ç½®å®Œæ•´å¼€å‘ç¯å¢ƒ   |
| `make check` | âœ… è¿è¡Œæ‰€æœ‰ä»£ç è´¨é‡æ£€æŸ¥    |
| `make test`  | ğŸ§ª è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š |
| `make cov`   | ğŸ§ª è¿è¡Œæµ‹è¯•å¹¶æ‰“å¼€è¦†ç›–ç‡æŠ¥å‘Š |
| `make run`   | â–¶ï¸ å¯åŠ¨å¼€å‘æœåŠ¡å™¨      |
| `make fmt`   | ğŸ¨ æ ¼å¼åŒ–ä»£ç         |
| `make lint`  | âœ¨ æ£€æŸ¥ä»£ç å¹¶è‡ªåŠ¨ä¿®å¤     |
| `make type`  | ğŸ” ç±»å‹æ£€æŸ¥         |
| `make audit` | ğŸ›¡ï¸ æ‰«æå®‰å…¨æ¼æ´      |
| `make clean` | ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶       |
| `make docker_build` | dockeræ‰“åŒ…        |
| `make docker_run`   | è¿è¡Œ docker é•œåƒ    |

## ğŸ”§ API æ¥å£

### å¿«é€Ÿæµ‹è¯•è„šæœ¬

ä½¿ç”¨é¡¹ç›®å†…ç½®çš„æµ‹è¯•è„šæœ¬å¿«é€ŸéªŒè¯åŠŸèƒ½ï¼š
```bash
./.script/test.sh
```

### ä¸»è¦ç«¯ç‚¹

| ç«¯ç‚¹                                  | æ–¹æ³• | æè¿°             |
|-------------------------------------|------|----------------|
| `/`                                 | GET | API æ ¹è·¯å¾„å’Œä¿¡æ¯     |
| `/api/v1/health`                    | GET | å¥åº·æ£€æŸ¥           |
| `/api/v1/documents/upload-file`     | POST | æœ¬åœ°æ–‡ä»¶ä¸Šä¼          |
| `/api/v1/documents/upload-from-url` | POST | ä»COS URLä¸Šä¼      |
| `/api/v1/documents/save`            | POST | ä»¥JSONæ ¼å¼å­—ç¬¦ä¸²ä¸Šä¼ æ–‡æ¡£ |
| `/api/v1/search`                    | POST | æ–‡æ¡£æœç´¢           |
| `/api/v1/tasks/{task_id}`           | GET | æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€         |

### å¥åº·æ£€æŸ¥
```bash
curl http://localhost:8080/api/v1/health
```

### æ–‡æ¡£ä¸Šä¼ 
```bash
# æœ¬åœ°æ–‡ä»¶ä¸Šä¼ 
curl -X POST "http://localhost:8080/api/v1/documents/upload-file" \
  -F "file=@document.pdf" \
  -F "category=æŠ€æœ¯æ–‡æ¡£" \
  -F "tags=AI,æœºå™¨å­¦ä¹ "

# COS URLä¸Šä¼ 
curl -X POST "http://localhost:8080/api/v1/documents/upload-from-url" \
  -H "Content-Type: application/json" \
  -d '{"url": "https://your-cos-url/document.pdf"}'
```

### æœç´¢æ–‡æ¡£
```bash
curl -X POST "http://localhost:8080/api/v1/search" \
  -H "Content-Type: application/json" \
  -d '{"query": "æœºå™¨å­¦ä¹ ç®—æ³•", "top_k": 5}'
```

## ğŸ—ï¸ æ¶æ„è¯´æ˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Web Layer  â”‚â”€â”€â”€â–¶â”‚ Service Layerâ”‚â”€â”€â”€â–¶â”‚  Domain Layer   â”‚
â”‚   FastAPI   â”‚    â”‚   Service    â”‚    â”‚ Document/Search â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  Elasticsearch  â”‚
                   â”‚     9.x         â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **Web Layer**: FastAPI è·¯ç”±å’Œè¯·æ±‚å¤„ç†
- **Service Layer**: ä¸šåŠ¡é€»è¾‘ï¼Œæ–‡æ¡£å¤„ç†å’Œæœç´¢
- **Domain Layer**: é¢†åŸŸæ¨¡å‹å’Œå®ä½“å®šä¹‰
- **Storage**: Elasticsearch å­˜å‚¨å’Œæ£€ç´¢

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
make test

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
uv run pytest tests/test_api.py -v

# è¿è¡Œç‰¹å®šæµ‹è¯•ç”¨ä¾‹
uv run pytest tests/test_api.py::TestAPI::test_health_check_endpoint -v

# è¿è¡Œå¸¦è¾“å‡ºçš„æµ‹è¯•ï¼ˆç”¨äºè°ƒè¯•ï¼‰
uv run pytest tests/test_api.py -v -s

# æŸ¥çœ‹æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
open htmlcov/index.html
```

### æµ‹è¯•ç±»å‹

- **å•å…ƒæµ‹è¯•**: APIç«¯ç‚¹åŠŸèƒ½æµ‹è¯•
- **é›†æˆæµ‹è¯•**: æ–‡æ¡£ä¸Šä¼ å’Œæœç´¢æµç¨‹æµ‹è¯•  
- **æ€§èƒ½æµ‹è¯•**: ä¸Šä¼ æ€§èƒ½ç›‘æ§
- **è¾¹ç•Œæµ‹è¯•**: æœç´¢é²æ£’æ€§éªŒè¯

## ğŸ“ ä»£ç è´¨é‡

æœ¬é¡¹ç›®ä½¿ç”¨ä¼ä¸šçº§ä»£ç è´¨é‡æ ‡å‡†ï¼š

- **æ ¼å¼åŒ–**: Ruff (æ›¿ä»£ Black)
- **Linting**: Ruff (æ›¿ä»£ Flake8 + å¤šç§æ’ä»¶)  
- **ç±»å‹æ£€æŸ¥**: MyPy (strict æ¨¡å¼)
- **æµ‹è¯•**: Pytest + è¦†ç›–ç‡æŠ¥å‘Š
- **å®‰å…¨æ£€æŸ¥**: pip-audit
- **é¢„æäº¤é’©å­**: è‡ªåŠ¨ä»£ç æ£€æŸ¥

## ğŸ¤ å¼€å‘æµç¨‹

1. **ä»£ç ä¿®æ”¹åè¿è¡Œæ£€æŸ¥:**
   ```bash
   make check  # æ ¼å¼åŒ– + lint + ç±»å‹æ£€æŸ¥
   ```

2. **æäº¤ä»£ç :**
   ```bash
   git add .
   git commit -m "feat: æ·»åŠ æ–°åŠŸèƒ½"  
   # è‡ªåŠ¨è§¦å‘é¢„æäº¤é’©å­æ£€æŸ¥
   ```

3. **æ¨é€ä»£ç :**
   ```bash
   git push
   # è‡ªåŠ¨è§¦å‘æµ‹è¯•å’Œå®‰å…¨æ£€æŸ¥
   ```

## ğŸ”§ é…ç½®

### ä¸»é…ç½®æ–‡ä»¶

é¡¹ç›®é…ç½®åœ¨ [`config.yaml`](./config.yaml)ï¼ŒåŒ…å«ä»¥ä¸‹ä¸»è¦é…ç½®ï¼š

- **Elasticsearch**: è¿æ¥URLã€ç´¢å¼•åç§°ã€è¶…æ—¶è®¾ç½®
- **åµŒå…¥æ¨¡å‹**: text2vec-base-chineseï¼Œ768ç»´å‘é‡
- **é‡æ’æ¨¡å‹**: BGE-reranker-base
- **æ–‡æ¡£å¤„ç†**: åˆ†ç‰‡å¤§å°ã€é‡å è®¾ç½®
- **ä¸Šä¼ é™åˆ¶**: æœ€å¤§50MBï¼Œæ”¯æŒ `.pdf` `.md` `.txt`
- **æ£€ç´¢é…ç½®**: å‘é‡å’Œæ–‡æœ¬æœç´¢æƒé‡å¯è°ƒ

### ç¯å¢ƒå˜é‡é…ç½®

è…¾è®¯äº‘COSé…ç½®é€šè¿‡ç¯å¢ƒå˜é‡è®¾ç½®ï¼ˆåˆ›å»º `.env` æ–‡ä»¶ï¼‰ï¼š

```bash
# è…¾è®¯äº‘COSé…ç½®
TENCENT_OSS__SECRET_ID=your_secret_id
TENCENT_OSS__SECRET_KEY=your_secret_key
TENCENT_OSS__BUCKET=your_bucket_name
TENCENT_OSS__REGION=your_region
```

### æµ‹è¯•é…ç½®

æµ‹è¯•ç¯å¢ƒé…ç½®åœ¨ [`tests/fixtures/config.yaml`](./tests/fixtures/config.yaml)

## ğŸ†˜ æ•…éšœæ’é™¤

### Q: uv å‘½ä»¤ä¸å­˜åœ¨
**A**: è¯·æŒ‰ç…§ä¸Šé¢çš„å®‰è£…æ­¥éª¤å®‰è£… uvï¼Œå¹¶ç¡®ä¿é‡æ–°åŠ è½½ç»ˆç«¯ç¯å¢ƒã€‚

### Q: Elasticsearch è¿æ¥å¤±è´¥  
**A**: ç¡®ä¿ ES æœåŠ¡è¿è¡Œåœ¨ localhost:9200ï¼Œæ£€æŸ¥ `config.yaml` é…ç½®ã€‚

### Q: COSä¸Šä¼ åŠŸèƒ½ä¸å¯ç”¨
**A**: æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„è…¾è®¯äº‘COSé…ç½®ï¼š
```bash
# ç¡®ä¿é…ç½®äº†æ­£ç¡®çš„COSç¯å¢ƒå˜é‡
TENCENT_OSS__SECRET_ID=your_secret_id
TENCENT_OSS__SECRET_KEY=your_secret_key
TENCENT_OSS__BUCKET=your_bucket_name
TENCENT_OSS__REGION=your_region
```

### Q: COSæƒé™ä¸è¶³é”™è¯¯
**A**: ç³»ç»Ÿå·²ä¼˜é›…å¤„ç†æƒé™é™åˆ¶ï¼š
- åº”ç”¨å¯åŠ¨æ—¶ä¼šè·³è¿‡COSè¿æ¥éªŒè¯
- å…ƒæ•°æ®è·å–å¤±è´¥æ—¶ä¼šä¼˜é›…é™çº§
- ç¡®ä¿COSå¯†é’¥è‡³å°‘æœ‰ `put_object` å’Œ `get_object` æƒé™

### Q: æµ‹è¯•å¤±è´¥
**A**: ç¡®ä¿ ES æœåŠ¡æ­£å¸¸è¿è¡Œï¼Œæ‰€æœ‰ä¾èµ–å·²å®‰è£…ï¼š
```bash
make setup  # é‡æ–°è®¾ç½®ç¯å¢ƒ
```

### Q: ä»£ç æ£€æŸ¥å¤±è´¥
**A**: è¿è¡Œè‡ªåŠ¨ä¿®å¤ï¼š
```bash
make check  # è‡ªåŠ¨æ ¼å¼åŒ–å’Œä¿®å¤å¤§éƒ¨åˆ†é—®é¢˜
```

---

ğŸ’¡ **æç¤º**: ä½¿ç”¨ `make help` æŸ¥çœ‹æ‰€æœ‰å¯ç”¨å‘½ä»¤

## Docker é•œåƒå’Œéƒ¨ç½²
Docker æ‰“åŒ…çš„æ—¶å€™ï¼Œå¿½ç•¥æ‰äº†å¾ˆå¤šæ–‡ä»¶ï¼Œå…·ä½“å¯ä»¥å‚è€ƒé¡¹ç›®ä¸‹çš„ .dockerignore æ–‡ä»¶ã€‚

å› æ­¤åœ¨ä½¿ç”¨ docker æ¥éƒ¨ç½²çš„æ—¶å€™ï¼Œå¿…é¡»æŒ‚è½½ï¼š
- .env æ–‡ä»¶
- config.yaml æ–‡ä»¶